{"version":3,"file":"OperationClient.cjs","sources":["../../../../src/plugins/operationModule/OperationClient.ts"],"sourcesContent":["import type { Metaplex } from '@/Metaplex';\nimport {\n  OperationConstructor,\n  Operation,\n  KeyOfOperation,\n  InputOfOperation,\n  OutputOfOperation,\n  OperationHandler,\n  OperationOptions,\n  OperationScope,\n} from '@/types';\nimport { Disposable, DisposableScope } from '@/utils';\nimport { OperationHandlerMissingError } from '@/errors';\n\n/**\n * @group Modules\n */\nexport class OperationClient {\n  /**\n   * Maps the name of an operation with its operation handler.\n   * Whilst the types on the Map are relatively loose, we ensure\n   * operations match with their handlers when registering them.\n   */\n  protected operationHandlers: Map<\n    string,\n    OperationHandler<any, any, any, any>\n  > = new Map();\n  constructor(protected readonly metaplex: Metaplex) {}\n\n  register<\n    T extends Operation<K, I, O>,\n    K extends string = KeyOfOperation<T>,\n    I = InputOfOperation<T>,\n    O = OutputOfOperation<T>\n  >(\n    operationConstructor: OperationConstructor<T, K, I, O>,\n    operationHandler: OperationHandler<T, K, I, O>\n  ) {\n    this.operationHandlers.set(operationConstructor.key, operationHandler);\n\n    return this;\n  }\n\n  get<\n    T extends Operation<K, I, O>,\n    K extends string = KeyOfOperation<T>,\n    I = InputOfOperation<T>,\n    O = OutputOfOperation<T>\n  >(operation: T): OperationHandler<T, K, I, O> {\n    const operationHandler = this.operationHandlers.get(operation.key) as\n      | OperationHandler<T, K, I, O>\n      | undefined;\n\n    if (!operationHandler) {\n      throw new OperationHandlerMissingError(operation.key);\n    }\n\n    return operationHandler;\n  }\n\n  async execute<\n    T extends Operation<K, I, O>,\n    K extends string = KeyOfOperation<T>,\n    I = InputOfOperation<T>,\n    O = OutputOfOperation<T>\n  >(operation: T, options: OperationOptions = {}): Promise<O> {\n    const operationHandler = this.get<T, K, I, O>(operation);\n    const signal = options.signal ?? new AbortController().signal;\n\n    return new Disposable(signal).run((scope) =>\n      operationHandler.handle(\n        operation,\n        this.metaplex,\n        this.getOperationScope(options, scope)\n      )\n    );\n  }\n\n  protected getOperationScope(\n    options: OperationOptions,\n    scope: DisposableScope\n  ): OperationScope {\n    if (!!options.commitment && !options.confirmOptions) {\n      options.confirmOptions = { commitment: options.commitment };\n    }\n\n    const payer = options.payer ?? this.metaplex.rpc().getDefaultFeePayer();\n\n    return { ...options, ...scope, payer };\n  }\n}\n"],"names":["OperationClient","constructor","metaplex","_defineProperty","Map","register","operationConstructor","operationHandler","operationHandlers","set","key","get","operation","OperationHandlerMissingError","execute","options","signal","AbortController","Disposable","run","scope","handle","getOperationScope","commitment","confirmOptions","payer","rpc","getDefaultFeePayer"],"mappings":";;;;;;;;AAcA;AACA;AACA;AACO,MAAMA,eAAe,CAAC;AAC3B;AACF;AACA;AACA;AACA;;EAKEC,WAAW,CAAoBC,QAAkB,EAAE;IAAAC,wCAD/C,CAAA,IAAA,EAAA,mBAAA,EAAA,IAAIC,GAAG,EAAE,CAAA,CAAA;IAAA,IACkBF,CAAAA,QAAkB,GAAlBA,QAAkB,CAAA;AAAG,GAAA;AAEpDG,EAAAA,QAAQ,CAMNC,oBAAsD,EACtDC,gBAA8C,EAC9C;IACA,IAAI,CAACC,iBAAiB,CAACC,GAAG,CAACH,oBAAoB,CAACI,GAAG,EAAEH,gBAAgB,CAAC,CAAA;AAEtE,IAAA,OAAO,IAAI,CAAA;AACb,GAAA;EAEAI,GAAG,CAKDC,SAAY,EAAgC;IAC5C,MAAML,gBAAgB,GAAG,IAAI,CAACC,iBAAiB,CAACG,GAAG,CAACC,SAAS,CAACF,GAAG,CAEpD,CAAA;IAEb,IAAI,CAACH,gBAAgB,EAAE;AACrB,MAAA,MAAM,IAAIM,qCAA4B,CAACD,SAAS,CAACF,GAAG,CAAC,CAAA;AACvD,KAAA;AAEA,IAAA,OAAOH,gBAAgB,CAAA;AACzB,GAAA;EAEA,MAAMO,OAAO,CAKXF,SAAY,EAAEG,OAAyB,GAAG,EAAE,EAAc;AAC1D,IAAA,MAAMR,gBAAgB,GAAG,IAAI,CAACI,GAAG,CAAaC,SAAS,CAAC,CAAA;IACxD,MAAMI,MAAM,GAAGD,OAAO,CAACC,MAAM,IAAI,IAAIC,eAAe,EAAE,CAACD,MAAM,CAAA;AAE7D,IAAA,OAAO,IAAIE,qBAAU,CAACF,MAAM,CAAC,CAACG,GAAG,CAAEC,KAAK,IACtCb,gBAAgB,CAACc,MAAM,CACrBT,SAAS,EACT,IAAI,CAACV,QAAQ,EACb,IAAI,CAACoB,iBAAiB,CAACP,OAAO,EAAEK,KAAK,CAAC,CACvC,CACF,CAAA;AACH,GAAA;AAEUE,EAAAA,iBAAiB,CACzBP,OAAyB,EACzBK,KAAsB,EACN;IAChB,IAAI,CAAC,CAACL,OAAO,CAACQ,UAAU,IAAI,CAACR,OAAO,CAACS,cAAc,EAAE;MACnDT,OAAO,CAACS,cAAc,GAAG;QAAED,UAAU,EAAER,OAAO,CAACQ,UAAAA;OAAY,CAAA;AAC7D,KAAA;AAEA,IAAA,MAAME,KAAK,GAAGV,OAAO,CAACU,KAAK,IAAI,IAAI,CAACvB,QAAQ,CAACwB,GAAG,EAAE,CAACC,kBAAkB,EAAE,CAAA;IAEvE,OAAO;AAAE,MAAA,GAAGZ,OAAO;AAAE,MAAA,GAAGK,KAAK;AAAEK,MAAAA,KAAAA;KAAO,CAAA;AACxC,GAAA;AACF;;;;"}